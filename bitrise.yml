format_version: 11
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: android

workflows:
  publish:
    before_run:
    - setup_env
    steps:
    - script@1:
        title: Download Dependencies
        inputs:
        - content: ./gradlew androidDependencies
    - script@1:
        title: Run Check
        inputs:
        - content: ./gradlew check
    - script@1:
        title: Assemble
        inputs:
        - content: ./gradlew assemble
    - script@1:
        title: Retrieve Base64 PGP Key and save to file
        inputs:
        - content: |-
            if [[ "$RELEASE_PGP_KEY_BASE64" != "" ]]; then
              base64 -d <<< "$RELEASE_PGP_KEY_BASE64" > /bitrise/src/validatetor/maven-central-key.gpg
            fi
    - script@1:
        title: Check if build is manual
        inputs:
        - content: |
            #!/usr/bin/env bash
            if [[ !$PR && $BITRISE_GIT_MESSAGE == "" ]]; then
                envman add --key IS_BUILD_MANUAL --value "true"
            else
                envman add --key IS_BUILD_MANUAL --value "false"
            fi
    - script@1:
        run_if: "{{ enveq "IS_BUILD_MANUAL" "false" }}"
        title: Publish
        inputs:
        - content: ./gradlew publish
  
  setup_env:
    steps:
    - set-java-version@1:
        inputs:
        - set_java_version: '8'
    - git-clone@6:
        inputs:
        - update_submodules: 'yes'

meta:
  bitrise.io:
    stack: linux-docker-android-20.04
    machine_type_id: elite

trigger_map:
- push_branch: "*"
  workflow: publish
- pull_request_source_branch: "*"
  workflow: publish
- tag: "v*.*.*"
  workflow: publish

app:
  envs:
  - opts:
      is_expand: false
    PROJECT_LOCATION: "."
  - opts:
      is_expand: false
    SDK_PATH: validatetor